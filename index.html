<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Certify</title>
        <link
            href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                padding: 0;
                font-family: "Roboto", sans-serif;
                background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
                color: #333;
            }
            .container {
                max-width: 960px;
                margin: 40px auto;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
                padding: 30px;
            }
            h1 {
                text-align: center;
                margin-bottom: 20px;
                font-weight: 700;
                color: #444;
            }
            .input-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
            }
            input[type="file"],
            input[type="text"],
            input[type="number"] {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 16px;
            }
            input[type="checkbox"] {
                margin-right: 5px;
                transform: scale(1.2);
            }
            #instructions {
                font-size: 14px;
                color: #777;
                margin-bottom: 15px;
            }
            #image-container {
                position: relative;
                margin: 20px 0;
                text-align: center;
            }
            #certificate-canvas {
                width: 100%;
                max-width: 100%;
                border: 2px solid #ddd;
                border-radius: 4px;
            }
            #overlay {
                position: absolute;
                border: 2px dashed #e74c3c;
                pointer-events: none;
                display: none;
            }
            button {
                background: #3498db;
                color: #fff;
                border: none;
                padding: 15px 30px;
                font-size: 16px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.3s ease;
                display: block;
                margin: 20px auto 0 auto;
            }
            button:hover:not([disabled]) {
                background: #2980b9;
            }
            button[disabled] {
                opacity: 0.7;
                cursor: not-allowed;
            }
            footer {
                position: absolute;
                top: 0;
                right: 0;
                margin: 10px;
                font-size: 14px;
                color: #777;
            }
            /* Spinner */
            @keyframes spinner {
                to {
                    transform: rotate(360deg);
                }
            }
            .spinner {
                width: 16px;
                height: 16px;
                margin-right: 8px;
                border: 2px solid #fff;
                border-top-color: transparent;
                border-radius: 50%;
                display: inline-block;
                animation: spinner 0.6s linear infinite;
                vertical-align: middle;
            }
            /* Modal styling */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                padding-top: 100px;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.4);
            }
            .modal-content {
                background: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 400px;
                border-radius: 8px;
                text-align: center;
            }
            .modal-content input,
            .modal-content select {
                margin-bottom: 15px;
            }
            .modal-content .btn-group {
                margin-top: 10px;
            }
            .resize-handle {
                position: absolute;
                width: 10px;
                height: 10px;
                background: #fff;
                border: 1px solid #e74c3c;
                z-index: 10;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Certify: Bulk Certificate Generator</h1>

            <div class="input-group">
                <label for="imageUpload">Upload Certificate Image:</label>
                <input type="file" id="imageUpload" accept="image/*" />
            </div>

            <div class="input-group">
                <label for="excelUpload">Upload Excel File:</label>
                <input type="file" id="excelUpload" accept=".xlsx, .xls" />
            </div>

            <div id="instructions">
                Draw a region on the certificate image to define where a label
                should appear. After releasing the mouse, a dialog will prompt
                you for the label, font size, font family, and a title-case
                option. You can add multiple regions.
                <br /><br />
                • To move/resize a region, click and drag (edges to resize,
                inside to move).<br />
                • Double-click a region to edit or delete it.
            </div>

            <div id="image-container">
                <canvas id="certificate-canvas"></canvas>
                <div id="overlay"></div>
            </div>

            <button id="submitBtn">Submit &amp; Generate Certificates</button>
        </div>

        <footer>
            <a
                href="https://github.com/akhilt2/Certify"
                target="_blank"
                style="text-decoration: none"
                title="Source Code"
                ><svg height="50" viewBox="0 0 24 24" alt="Github Logo">
                    <path
                        d="M12 1C5.9225 1 1 5.9225 1 12C1 16.8675 4.14875 20.9787 8.52125 22.4362C9.07125 22.5325 9.2775 22.2025 9.2775 21.9137C9.2775 21.6525 9.26375 20.7862 9.26375 19.865C6.5 20.3737 5.785 19.1912 5.565 18.5725C5.44125 18.2562 4.905 17.28 4.4375 17.0187C4.0525 16.8125 3.5025 16.3037 4.42375 16.29C5.29 16.2762 5.90875 17.0875 6.115 17.4175C7.105 19.0812 8.68625 18.6137 9.31875 18.325C9.415 17.61 9.70375 17.1287 10.02 16.8537C7.5725 16.5787 5.015 15.63 5.015 11.4225C5.015 10.2262 5.44125 9.23625 6.1425 8.46625C6.0325 8.19125 5.6475 7.06375 6.2525 5.55125C6.2525 5.55125 7.17375 5.2625 9.2775 6.67875C10.1575 6.43125 11.0925 6.3075 12.0275 6.3075C12.9625 6.3075 13.8975 6.43125 14.7775 6.67875C16.8813 5.24875 17.8025 5.55125 17.8025 5.55125C18.4075 7.06375 18.0225 8.19125 17.9125 8.46625C18.6138 9.23625 19.04 10.2125 19.04 11.4225C19.04 15.6437 16.4688 16.5787 14.0213 16.8537C14.42 17.1975 14.7638 17.8575 14.7638 18.8887C14.7638 20.36 14.75 21.5425 14.75 21.9137C14.75 22.2025 14.9563 22.5462 15.5063 22.4362C19.8513 20.9787 23 16.8537 23 12C23 5.9225 18.0775 1 12 1Z"
                    ></path></svg
            ></a>
        </footer>

        <!-- Modal for new/edit region -->
        <div id="regionModal" class="modal">
            <div class="modal-content">
                <h3 id="modalTitle">New Region</h3>
                <label for="regionLabel">Label:</label>
                <input type="text" id="regionLabel" placeholder="Label name" />
                <div style="margin: 10px 0">
                    <input type="checkbox" id="regionTitleCase" checked />
                    <label for="regionTitleCase" style="display: inline"
                        >Capitalize first letter of each word</label
                    >
                </div>
                <label for="regionFontSize">Font Size (px):</label>
                <input type="number" id="regionFontSize" value="60" />
                <label for="regionFontFamily">Font Family:</label>
                <select id="regionFontFamily">
                    <option value="Brush Script MT, cursive" selected>
                        Brush Script MT
                    </option>
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                </select>
                <div class="btn-group">
                    <button id="saveRegionBtn">Save</button>
                    <button
                        id="deleteRegionBtn"
                        style="display: none; background: #e74c3c"
                    >
                        Delete
                    </button>
                    <button id="cancelRegionBtn" style="background: #95a5a6">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <script>
            // Utility: Title Case
            function toTitleCase(str) {
                return str
                    .split(" ")
                    .map(
                        (w) =>
                            w.charAt(0).toUpperCase() +
                            w.slice(1).toLowerCase(),
                    )
                    .join(" ");
            }

            // Utility: Wrapped text that centers vertically
            function drawWrappedText(ctx, text, x, y, w, h, lineH) {
                const words = text.split(" ");
                const lines = [];
                let line = "";
                for (let word of words) {
                    const test = line + word + " ";
                    if (ctx.measureText(test).width > w && line) {
                        lines.push(line.trim());
                        line = word + " ";
                    } else {
                        line = test;
                    }
                }
                if (line) lines.push(line.trim());
                const totalH = lines.length * lineH;
                let startY = y + (h - totalH) / 2 + lineH / 2;
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], x + w / 2, startY + i * lineH);
                }
            }

            // Region-drawing globals
            let image = new Image();
            let canvas = document.getElementById("certificate-canvas");
            let ctx = canvas.getContext("2d");
            let overlay = document.getElementById("overlay");
            let selections = []; // holds defined regions
            let pendingRegion = null; // for new region
            let activeRegionIndex = null;
            let isDragging = false;
            let resizeMode = false;
            let resizeDirection = null;
            const resizeThreshold = 10;

            // Modal elements
            const regionModal = document.getElementById("regionModal");
            const modalTitle = document.getElementById("modalTitle");
            const regionLabelInput = document.getElementById("regionLabel");
            const regionTitleCaseInput =
                document.getElementById("regionTitleCase");
            const regionFontSizeInput =
                document.getElementById("regionFontSize");
            const regionFontFamilySelect =
                document.getElementById("regionFontFamily");
            const saveRegionBtn = document.getElementById("saveRegionBtn");
            const deleteRegionBtn = document.getElementById("deleteRegionBtn");
            const cancelRegionBtn = document.getElementById("cancelRegionBtn");

            // Redraw canvas with regions
            function redrawCanvas() {
                if (!image.src) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(image, 0, 0);
                selections.forEach((sel) => {
                    ctx.strokeStyle = "#e74c3c";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(sel.x, sel.y, sel.width, sel.height);
                    ctx.fillStyle = "rgba(231,76,60,0.2)";
                    ctx.fillRect(sel.x, sel.y, sel.width, sel.height);
                    ctx.font = `bold ${sel.fontSize}px ${sel.fontFamily}`;
                    ctx.fillStyle = "#e74c3c";
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
                    drawWrappedText(
                        ctx,
                        sel.label,
                        sel.x,
                        sel.y,
                        sel.width,
                        sel.height,
                        Math.round(sel.fontSize * 0.5),
                    );
                });
            }

            // Load image and adjust canvas
            document
                .getElementById("imageUpload")
                .addEventListener("change", (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        image.onload = () => {
                            canvas.width = image.width;
                            canvas.height = image.height;
                            redrawCanvas();
                            const rect = canvas.getBoundingClientRect();
                            overlay.style.width = rect.width + "px";
                            overlay.style.height = rect.height + "px";
                            overlay.style.left = "0px";
                            overlay.style.top = "0px";
                        };
                        image.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });

            // Mouse helpers
            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY,
                };
            }
            function toDisplay(val, axis = "x") {
                const rect = canvas.getBoundingClientRect();
                return axis === "x"
                    ? val * (rect.width / canvas.width)
                    : val * (rect.height / canvas.height);
            }

            // Canvas mouse events for drawing/moving/resizing
            canvas.addEventListener("mousedown", (e) => {
                const pos = getMousePos(e);
                let hit = null;
                selections.forEach((sel, idx) => {
                    if (
                        pos.x >= sel.x &&
                        pos.x <= sel.x + sel.width &&
                        pos.y >= sel.y &&
                        pos.y <= sel.y + sel.height
                    ) {
                        hit = idx;
                    }
                });
                if (hit !== null) {
                    activeRegionIndex = hit;
                    const sel = selections[hit];
                    const onLeft = Math.abs(pos.x - sel.x) < resizeThreshold;
                    const onRight =
                        Math.abs(pos.x - (sel.x + sel.width)) < resizeThreshold;
                    const onTop = Math.abs(pos.y - sel.y) < resizeThreshold;
                    const onBottom =
                        Math.abs(pos.y - (sel.y + sel.height)) <
                        resizeThreshold;
                    if (onLeft || onRight || onTop || onBottom) {
                        resizeMode = true;
                        if (onLeft && onTop) resizeDirection = "nw";
                        else if (onRight && onTop) resizeDirection = "ne";
                        else if (onLeft && onBottom) resizeDirection = "sw";
                        else if (onRight && onBottom) resizeDirection = "se";
                        else if (onLeft) resizeDirection = "w";
                        else if (onRight) resizeDirection = "e";
                        else if (onTop) resizeDirection = "n";
                        else if (onBottom) resizeDirection = "s";
                    } else {
                        resizeMode = false;
                        const dx = pos.x - sel.x;
                        const dy = pos.y - sel.y;
                        dragOffset = { x: dx, y: dy };
                    }
                    isDragging = true;
                } else {
                    pendingRegion = { x: pos.x, y: pos.y, width: 0, height: 0 };
                    isDragging = true;
                }
            });

            canvas.addEventListener("mousemove", (e) => {
                const pos = getMousePos(e);
                if (isDragging && pendingRegion) {
                    pendingRegion.width = Math.abs(pos.x - pendingRegion.x);
                    pendingRegion.height = Math.abs(pos.y - pendingRegion.y);
                    pendingRegion.x = Math.min(pos.x, pendingRegion.x);
                    pendingRegion.y = Math.min(pos.y, pendingRegion.y);
                    overlay.style.display = "block";
                    overlay.style.left = toDisplay(pendingRegion.x) + "px";
                    overlay.style.top = toDisplay(pendingRegion.y, "y") + "px";
                    overlay.style.width = toDisplay(pendingRegion.width) + "px";
                    overlay.style.height =
                        toDisplay(pendingRegion.height, "y") + "px";
                } else if (isDragging && activeRegionIndex !== null) {
                    const sel = selections[activeRegionIndex];
                    if (resizeMode) {
                        if (resizeDirection.includes("n")) {
                            const diff = pos.y - sel.y;
                            sel.y = pos.y;
                            sel.height -= diff;
                        }
                        if (resizeDirection.includes("s")) {
                            sel.height = pos.y - sel.y;
                        }
                        if (resizeDirection.includes("w")) {
                            const diff = pos.x - sel.x;
                            sel.x = pos.x;
                            sel.width -= diff;
                        }
                        if (resizeDirection.includes("e")) {
                            sel.width = pos.x - sel.x;
                        }
                    } else {
                        sel.x = pos.x - dragOffset.x;
                        sel.y = pos.y - dragOffset.y;
                    }
                    redrawCanvas();
                }
            });

            canvas.addEventListener("mouseup", (e) => {
                isDragging = false;
                if (pendingRegion) {
                    overlay.style.display = "none";
                    openRegionModal("new", null, pendingRegion);
                    pendingRegion = null;
                }
                activeRegionIndex = null;
                resizeMode = false;
            });

            canvas.addEventListener("dblclick", (e) => {
                const pos = getMousePos(e);
                let hit = null;
                selections.forEach((sel, idx) => {
                    if (
                        pos.x >= sel.x &&
                        pos.x <= sel.x + sel.width &&
                        pos.y >= sel.y &&
                        pos.y <= sel.y + sel.height
                    ) {
                        hit = idx;
                    }
                });
                if (hit !== null) {
                    openRegionModal("edit", hit, selections[hit]);
                }
            });

            // Open modal
            function openRegionModal(mode, idx, data) {
                regionModal.style.display = "block";
                if (mode === "new") {
                    modalTitle.textContent = "New Region";
                    regionLabelInput.value = "";
                    regionTitleCaseInput.checked = true;
                    regionFontSizeInput.value = 60;
                    regionFontFamilySelect.value = "Brush Script MT, cursive";
                    deleteRegionBtn.style.display = "none";
                    saveRegionBtn.onclick = () => {
                        const label = regionLabelInput.value.trim();
                        if (!label) {
                            alert("Enter a label");
                            return;
                        }
                        selections.push({
                            x: data.x,
                            y: data.y,
                            width: data.width,
                            height: data.height,
                            label,
                            titleCase: regionTitleCaseInput.checked,
                            fontSize: +regionFontSizeInput.value || 60,
                            fontFamily: regionFontFamilySelect.value,
                        });
                        regionModal.style.display = "none";
                        redrawCanvas();
                    };
                } else {
                    modalTitle.textContent = "Edit Region";
                    deleteRegionBtn.style.display = "inline-block";
                    regionLabelInput.value = data.label;
                    regionTitleCaseInput.checked = data.titleCase;
                    regionFontSizeInput.value = data.fontSize;
                    regionFontFamilySelect.value = data.fontFamily;
                    saveRegionBtn.onclick = () => {
                        const label = regionLabelInput.value.trim();
                        if (!label) {
                            alert("Enter a label");
                            return;
                        }
                        selections[idx].label = label;
                        selections[idx].titleCase =
                            regionTitleCaseInput.checked;
                        selections[idx].fontSize =
                            +regionFontSizeInput.value || 60;
                        selections[idx].fontFamily =
                            regionFontFamilySelect.value;
                        regionModal.style.display = "none";
                        redrawCanvas();
                    };
                    deleteRegionBtn.onclick = () => {
                        if (confirm("Delete this region?")) {
                            selections.splice(idx, 1);
                            regionModal.style.display = "none";
                            redrawCanvas();
                        }
                    };
                }
            }

            cancelRegionBtn.onclick = () =>
                (regionModal.style.display = "none");
            window.onclick = (e) => {
                if (e.target === regionModal)
                    regionModal.style.display = "none";
            };

            // Spinner helpers
            const submitBtn = document.getElementById("submitBtn");
            function showSpinner() {
                submitBtn.disabled = true;
                submitBtn.innerHTML =
                    '<span class="spinner"></span>Generating…';
            }
            function hideSpinner() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = "Submit &amp; Generate Certificates";
            }

            // Initialize worker
            const worker = new Worker("cert-worker.js");

            // Handle worker messages
            worker.onmessage = (e) => {
                if (e.data.error) {
                    alert("Error: " + e.data.error);
                } else {
                    const blob = new Blob([e.data], {
                        type: "application/zip",
                    });
                    saveAs(blob, "certificates.zip");
                }
                hideSpinner();
            };
            worker.onerror = (err) => {
                console.error(err);
                alert("Worker error");
                hideSpinner();
            };

            // Submit button posts data to worker
            submitBtn.addEventListener("click", () => {
                if (!image.src) {
                    alert("Please upload a certificate image.");
                    return;
                }
                const excelFile =
                    document.getElementById("excelUpload").files[0];
                if (!excelFile) {
                    alert("Please upload an Excel file.");
                    return;
                }
                if (!selections.length) {
                    alert("Please draw at least one region.");
                    return;
                }
                showSpinner();
                const fr = new FileReader();
                fr.onload = (ev) => {
                    worker.postMessage(
                        {
                            imgDataURL: (() => {
                                const tmp = document.createElement("canvas");
                                tmp.width = image.width;
                                tmp.height = image.height;
                                tmp.getContext("2d").drawImage(image, 0, 0);
                                return tmp.toDataURL("image/png");
                            })(),
                            imgW: image.width,
                            imgH: image.height,
                            selections,
                            excelBuffer: ev.target.result,
                        },
                        [ev.target.result],
                    );
                };
                fr.readAsArrayBuffer(excelFile);
            });
        </script>
    </body>
</html>
